<% content_for :header_actions do %>
  <a href="<%= engine_llm.settings_path %>" class="text-sm text-gray-500 hover:text-gray-700">Settings</a>
<% end %>

<div class="flex flex-col h-[calc(100vh-64px)]">
  <%# Chat header %>
  <div class="flex justify-between items-center px-4 py-3 border-b border-gray-200 bg-white">
    <strong class="text-gray-900"><%= @conversation.title %></strong>
    <div class="flex items-center gap-3">
      <%= ds_badge label: (@conversation.model&.split(":")&.last || "default"), color: :gray %>
      <a href="<%= engine_llm.conversations_path %>" class="text-sm text-gray-500 hover:text-gray-700">Back</a>
    </div>
  </div>

  <%# Messages %>
  <div class="flex-1 overflow-y-auto px-4 py-4 space-y-4" id="chat-messages">
    <% messages = @conversation.read_attribute(:transcript) || [] %>
    <% if messages.empty? %>
      <div class="text-center text-gray-400 mt-12">
        <p>Send a message to start the conversation.</p>
      </div>
    <% else %>
      <% messages.each do |msg| %>
        <div class="flex <%= msg["role"] == "user" ? "justify-end" : "justify-start" %>">
          <div class="max-w-[75%] rounded-lg px-4 py-2 <%= msg["role"] == "user" ? "bg-primary-600 text-white" : "bg-gray-100 text-gray-900" %>">
            <div class="text-xs font-medium mb-1 <%= msg["role"] == "user" ? "text-primary-200" : "text-gray-500" %>"><%= msg["role"] %></div>
            <div class="text-sm whitespace-pre-wrap"><%= msg["content"] %></div>
          </div>
        </div>
      <% end %>
    <% end %>
  </div>

  <%# Input %>
  <div class="border-t border-gray-200 bg-white px-4 py-3">
    <%= form_with url: engine_llm.conversation_messages_path(@conversation), method: :post, local: true, class: "flex gap-2" do |f| %>
      <%= f.text_area :content, placeholder: "Type your message...", rows: 1, autofocus: true,
          class: "flex-1 resize-none rounded-md border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500" %>
      <%= f.submit "Send", class: "inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-primary-600 rounded-md hover:bg-primary-700 cursor-pointer" %>
    <% end %>
  </div>
</div>

<script>
  // Auto-scroll to bottom of chat
  var messages = document.getElementById("chat-messages");
  if (messages) { messages.scrollTop = messages.scrollHeight; }

  // Auto-resize textarea
  var textarea = document.querySelector(".border-t textarea");
  if (textarea) {
    textarea.addEventListener("input", function() {
      this.style.height = "auto";
      this.style.height = Math.min(this.scrollHeight, 120) + "px";
    });
    // Submit on Enter (Shift+Enter for newline)
    textarea.addEventListener("keydown", function(e) {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        this.closest("form").submit();
      }
    });
  }
</script>
